{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title %}Event Bookings - EventAdmin{% endblock %}

{% block extra_css %}
<style>
    /* Glass Utilities */
    .glass-panel {
        background: rgba(30, 41, 59, 0.4);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .glass-input {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #e2e8f0;
    }

    .glass-input:focus {
        border-color: #3b82f6;
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    /* Custom Checkbox */
    .custom-checkbox {
        appearance: none;
        background-color: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        display: inline-block;
        position: relative;
        cursor: pointer;
    }

    .custom-checkbox:checked {
        background-color: #3b82f6;
        border-color: #3b82f6;
    }

    .custom-checkbox:checked::after {
        content: '\2714';
        font-size: 10px;
        color: white;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    /* Table Row Hover */
    .table-row-hover:hover {
        background-color: rgba(255, 255, 255, 0.03);
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-fade-in-up">

    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white tracking-tight">Event Bookings</h1>
            <p class="text-slate-400 mt-1 text-sm">Manage reservations and ticket sales.</p>
        </div>

        <div class="flex flex-col sm:flex-row gap-3">
            <div class="relative group">
                <i
                    class="fas fa-search absolute left-3 top-3 text-slate-500 group-focus-within:text-blue-400 transition-colors"></i>
                <input type="text" id="searchInput" placeholder="Search customer or ID..."
                    class="glass-input w-full sm:w-64 pl-10 pr-4 py-2.5 rounded-xl text-sm transition-all">
            </div>

            <div class="relative">
                <button id="filterBtn"
                    class="glass-input px-4 py-2.5 rounded-xl text-sm font-medium hover:bg-white/5 transition-all flex items-center gap-2 text-slate-300">
                    <i class="fas fa-filter text-slate-400"></i>
                    <span>Filter</span>
                    <span id="filterCount"
                        class="hidden bg-blue-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">0</span>
                </button>

                <div id="filterDropdown"
                    class="hidden absolute right-0 mt-2 w-72 bg-[#0f172a] border border-white/10 rounded-xl shadow-2xl shadow-black/50 p-4 z-50 backdrop-blur-xl">
                    <div class="space-y-4">
                        <div>
                            <label
                                class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Status</label>
                            <div class="flex flex-wrap gap-2">
                                {% for status, label in status_choices %}
                                <label class="cursor-pointer">
                                    <input type="checkbox" name="status_filter" value="{{ status }}"
                                        class="peer sr-only">
                                    <span
                                        class="inline-block px-3 py-1 rounded-lg text-xs font-medium border border-white/10 text-slate-400 peer-checked:bg-blue-500/20 peer-checked:text-blue-400 peer-checked:border-blue-500/50 transition-all hover:bg-white/5">
                                        {{ label }}
                                    </span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Date
                                Range</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="date" id="startDate" class="glass-input px-2 py-1.5 rounded-lg text-xs">
                                <input type="date" id="endDate" class="glass-input px-2 py-1.5 rounded-lg text-xs">
                            </div>
                        </div>
                        <div class="pt-3 border-t border-white/10 flex justify-between">
                            <button id="clearFilters" class="text-xs text-slate-500 hover:text-slate-300">Clear</button>
                            <button id="applyFilters"
                                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded-lg transition-colors">Apply</button>
                        </div>
                    </div>
                </div>
            </div>

            <a href="{% url 'event_book_add' %}"
                class="flex items-center justify-center gap-2 px-5 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white text-sm font-bold rounded-xl shadow-lg shadow-blue-500/20 transition-all transform hover:-translate-y-0.5">
                <i class="fas fa-plus"></i>
                <span class="hidden sm:inline">New Booking</span>
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div
            class="glass-panel p-5 rounded-xl flex items-center justify-between group hover:bg-white/5 transition-colors">
            <div>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Total Bookings</p>
                <h3 class="text-2xl font-bold text-white mt-1">{{ total_bookings }}</h3>
                <span class="text-emerald-400 text-xs flex items-center mt-1"><i class="fas fa-arrow-up mr-1"></i>
                    12%</span>
            </div>
            <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center border border-blue-500/20">
                <i class="fas fa-ticket-alt text-blue-400"></i>
            </div>
        </div>
        <div
            class="glass-panel p-5 rounded-xl flex items-center justify-between group hover:bg-white/5 transition-colors">
            <div>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Total Revenue</p>
                <h3 class="text-2xl font-bold text-white mt-1">₹{{ total_revenue|floatformat:0 }}</h3>
                <span class="text-emerald-400 text-xs flex items-center mt-1"><i class="fas fa-arrow-up mr-1"></i>
                    18%</span>
            </div>
            <div
                class="w-10 h-10 rounded-lg bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20">
                <i class="fas fa-wallet text-emerald-400"></i>
            </div>
        </div>
        <div
            class="glass-panel p-5 rounded-xl flex items-center justify-between group hover:bg-white/5 transition-colors">
            <div>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Confirmed</p>
                <h3 class="text-2xl font-bold text-white mt-1">{{ confirmed_bookings }}</h3>
                <div class="w-16 h-1 bg-slate-700 rounded-full mt-2 overflow-hidden">
                    <div class="bg-emerald-500 h-full" style="width: {{ confirmed_percentage }}%"></div>
                </div>
            </div>
            <div
                class="w-10 h-10 rounded-lg bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20">
                <i class="fas fa-check-circle text-emerald-400"></i>
            </div>
        </div>
        <div
            class="glass-panel p-5 rounded-xl flex items-center justify-between group hover:bg-white/5 transition-colors">
            <div>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Pending</p>
                <h3 class="text-2xl font-bold text-white mt-1">{{ pending_bookings }}</h3>
                <div class="w-16 h-1 bg-slate-700 rounded-full mt-2 overflow-hidden">
                    <div class="bg-amber-500 h-full" style="width: {{ pending_percentage }}%"></div>
                </div>
            </div>
            <div
                class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center border border-amber-500/20">
                <i class="fas fa-clock text-amber-400"></i>
            </div>
        </div>
    </div>

    <div class="glass-panel rounded-2xl overflow-hidden">
        <div
            class="px-6 py-4 border-b border-white/5 flex flex-col sm:flex-row sm:items-center justify-between gap-4 bg-white/5">
            <h2 class="text-lg font-bold text-white">Recent Transactions</h2>

            <div class="flex items-center gap-3">
                <select id="bulkActions" class="glass-input px-3 py-1.5 rounded-lg text-xs font-medium text-slate-300">
                    <option value="">Bulk Actions</option>
                    <option value="confirm">Mark Confirmed</option>
                    <option value="cancel">Mark Cancelled</option>
                    <option value="delete">Delete Selected</option>
                </select>
                <button
                    class="px-3 py-1.5 glass-input rounded-lg text-xs font-medium text-slate-300 hover:text-white hover:border-white/30 transition-colors">
                    <i class="fas fa-download mr-1"></i> Export
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-left">
                <thead class="bg-slate-900/50 border-b border-white/5">
                    <tr>
                        <th class="px-6 py-4 w-10">
                            <input type="checkbox" id="selectAll" class="custom-checkbox w-4 h-4">
                        </th>
                        <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Booking ID</th>
                        <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Customer</th>
                        <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Event Info</th>
                        <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Tickets</th>
                        <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Amount</th>
                        <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-right">
                            Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5" id="bookingsTableBody">
                    {% for booking in bookings %}
                    <tr class="table-row-hover transition-colors group booking-row" data-status="{{ booking.status }}">
                        <td class="px-6 py-4">
                            <input type="checkbox" class="custom-checkbox booking-checkbox w-4 h-4"
                                value="{{ booking.id }}">
                        </td>

                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded bg-slate-800 flex items-center justify-center text-slate-500 font-mono text-xs">
                                    <i class="fas fa-hashtag"></i>
                                </div>
                                <div>
                                    <span class="block text-sm font-mono text-blue-400">#{{
                                        booking.id|stringformat:"06d" }}</span>
                                    <span class="text-[10px] text-slate-500">{{ booking.booking_date|date:"M d, Y"
                                        }}</span>
                                </div>
                            </div>
                        </td>

                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-300">
                                    {{ booking.customer_name|first|upper }}
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-slate-200">{{ booking.customer_name }}</div>
                                    <div class="text-xs text-slate-500">{{ booking.customer_email }}</div>
                                </div>
                            </div>
                        </td>

                        <td class="px-6 py-4">
                            <div class="text-sm text-slate-300 font-medium">{{ booking.event.name|default:"Unknown
                                Event" }}</div>
                            <div class="text-xs text-slate-500 flex items-center gap-1 mt-0.5">
                                <i class="far fa-calendar-alt"></i> {{ booking.event.date|date:"M d" }}
                            </div>
                        </td>

                        <td class="px-6 py-4">
                            <span
                                class="px-2.5 py-1 rounded-md bg-slate-800 border border-slate-700 text-xs text-slate-300">
                                {{ booking.number_of_tickets }}
                            </span>
                        </td>

                        <td class="px-6 py-4">
                            <div class="text-sm font-bold text-white">₹{{ booking.total_amount|floatformat:2 }}</div>
                            <div class="text-[10px] uppercase font-bold tracking-wide mt-0.5
                                {% if booking.payment_status %}text-emerald-500{% else %}text-amber-500{% endif %}">
                                {% if booking.payment_status %}Paid{% else %}Unpaid{% endif %}
                            </div>
                        </td>

                        <td class="px-6 py-4">
                            {% with status=booking.status %}
                            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold border
                                {% if status == 'confirmed' %} bg-emerald-500/10 text-emerald-400 border-emerald-500/20
                                {% elif status == 'pending' %} bg-amber-500/10 text-amber-400 border-amber-500/20
                                {% elif status == 'cancelled' %} bg-red-500/10 text-red-400 border-red-500/20
                                {% else %} bg-blue-500/10 text-blue-400 border-blue-500/20 {% endif %}">
                                <span
                                    class="w-1.5 h-1.5 rounded-full 
                                    {% if status == 'confirmed' %}bg-emerald-400{% elif status == 'pending' %}bg-amber-400{% elif status == 'cancelled' %}bg-red-400{% else %}bg-blue-400{% endif %}">
                                </span>
                                {{ status|title }}
                            </span>
                            {% endwith %}
                        </td>

                        <td class="px-6 py-4 text-right">
                            <div
                                class="flex items-center justify-end gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                                <a href="{% url 'event_book_view' booking.id %}"
                                    class="p-1.5 rounded-lg hover:bg-blue-500/20 hover:text-blue-400 text-slate-400 transition-colors"
                                    title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'event_book_edit' booking.id %}"
                                    class="p-1.5 rounded-lg hover:bg-amber-500/20 hover:text-amber-400 text-slate-400 transition-colors"
                                    title="Edit">
                                    <i class="fas fa-pen"></i>
                                </a>
                                <button type="button"
                                    class="p-1.5 rounded-lg hover:bg-red-500/20 hover:text-red-400 text-slate-400 transition-colors delete-btn"
                                    data-id="{{ booking.id }}" data-name="{{ booking.customer_name }}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-6 py-16 text-center">
                            <div
                                class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-700">
                                <i class="fas fa-inbox text-2xl text-slate-500"></i>
                            </div>
                            <h3 class="text-white font-medium">No bookings found</h3>
                            <p class="text-slate-500 text-sm mt-1">Try adjusting filters or create a new booking.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if bookings.has_other_pages %}
        <div class="px-6 py-4 border-t border-white/5 flex items-center justify-between bg-slate-900/30">
            <div class="text-xs text-slate-400">
                Showing <span class="font-medium text-white">{{ bookings.start_index }}</span> to <span
                    class="font-medium text-white">{{ bookings.end_index }}</span> of {{ bookings.paginator.count }}
                entries
            </div>
            <div class="flex gap-2">
                {% if bookings.has_previous %}
                <a href="?page={{ bookings.previous_page_number }}"
                    class="px-3 py-1.5 rounded-lg border border-white/10 text-xs font-medium text-slate-300 hover:bg-white/5 transition-colors">Previous</a>
                {% endif %}

                {% for num in bookings.paginator.page_range %}
                {% if bookings.number == num %}
                <span
                    class="px-3 py-1.5 rounded-lg bg-blue-600 text-xs font-bold text-white shadow-lg shadow-blue-500/20">{{
                    num }}</span>
                {% elif num > bookings.number|add:'-3' and num < bookings.number|add:'3' %} <a href="?page={{ num }}"
                    class="px-3 py-1.5 rounded-lg border border-white/10 text-xs font-medium text-slate-300 hover:bg-white/5 transition-colors">
                    {{ num }}</a>
                    {% endif %}
                    {% endfor %}

                    {% if bookings.has_next %}
                    <a href="?page={{ bookings.next_page_number }}"
                        class="px-3 py-1.5 rounded-lg border border-white/10 text-xs font-medium text-slate-300 hover:bg-white/5 transition-colors">Next</a>
                    {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div id="deleteModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0" id="modalBackdrop"></div>

    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative w-full max-w-md bg-[#0f172a] border border-white/10 rounded-2xl shadow-2xl transform scale-95 opacity-0 transition-all duration-300"
            id="modalContent">
            <div class="p-6 text-center">
                <div
                    class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Delete Booking?</h3>
                <p class="text-slate-400 text-sm mb-6">
                    Are you sure you want to delete the booking for <span id="deleteName"
                        class="text-white font-medium"></span>?
                    <br>This action cannot be undone.
                </p>
                <div class="flex gap-3 justify-center">
                    <button id="cancelDelete"
                        class="px-5 py-2.5 rounded-xl border border-white/10 text-slate-300 hover:bg-white/5 text-sm font-medium transition-colors">Cancel</button>
                    <button id="confirmDelete"
                        class="px-5 py-2.5 rounded-xl bg-red-600 hover:bg-red-500 text-white text-sm font-bold shadow-lg shadow-red-500/20 transition-colors">Delete
                        Booking</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. Filter Dropdown Logic ---
        const filterBtn = document.getElementById('filterBtn');
        const filterDropdown = document.getElementById('filterDropdown');

        filterBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            filterDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!filterDropdown.contains(e.target) && !filterBtn.contains(e.target)) {
                filterDropdown.classList.add('hidden');
            }
        });

        // --- 2. Search Logic (Client Side Simple) ---
        const searchInput = document.getElementById('searchInput');
        const rows = document.querySelectorAll('.booking-row');

        searchInput.addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        });

        // --- 3. Checkbox Logic ---
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.booking-checkbox');

        selectAll.addEventListener('change', function () {
            checkboxes.forEach(cb => cb.checked = this.checked);
        });

        // --- 4. Modal Logic (with Animations) ---
        const deleteModal = document.getElementById('deleteModal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalContent = document.getElementById('modalContent');
        const deleteNameSpan = document.getElementById('deleteName');
        let bookingToDelete = null;

        function openModal() {
            deleteModal.classList.remove('hidden');
            // Small delay to allow display:block to apply before animating opacity
            setTimeout(() => {
                modalBackdrop.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            modalBackdrop.classList.add('opacity-0');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                deleteModal.classList.add('hidden');
                bookingToDelete = null;
            }, 300);
        }

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                bookingToDelete = this.dataset.id;
                deleteNameSpan.textContent = this.dataset.name;
                openModal();
            });
        });

        document.getElementById('cancelDelete').addEventListener('click', closeModal);

        document.getElementById('confirmDelete').addEventListener('click', function () {
            if (bookingToDelete) {
                // Here you would make an AJAX call or submit a form
                // For demo, we simulate success
                closeModal();

                // Show Global Notification (defined in base.html)
                if (window.showNotification) {
                    window.showNotification('Booking deleted successfully', 'success');
                }

                // Remove row
                const row = document.querySelector(`.delete-btn[data-id="${bookingToDelete}"]`).closest('tr');
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }
        });

        // --- 5. Bulk Actions (Demo) ---
        const bulkSelect = document.getElementById('bulkActions');
        bulkSelect.addEventListener('change', function () {
            const selected = document.querySelectorAll('.booking-checkbox:checked').length;
            if (this.value && selected > 0) {
                if (window.showNotification) {
                    window.showNotification(`Applied ${this.options[this.selectedIndex].text} to ${selected} items`, 'info');
                }
                this.value = ""; // Reset
            } else if (this.value) {
                if (window.showNotification) window.showNotification('Please select items first', 'error');
                this.value = "";
            }
        });
    });
</script>
{% endblock %}